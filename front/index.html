<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DogFeeder</title>
    <link rel="stylesheet" href="./style.css" />
    <script>
      function renderTable(data) {
        const tabela = document.getElementById("tabela");

        const tableContent = [
          "<table>",
          "<thead>",
          "<tr>",
          "<th>data</th>",
          "<th>peso total</th>",
          "<th>mudança de peso</th>",
          "<th>altura do reservatório</th>",
          "</tr>",
          "</thead>",
          "<tbody>",
          data
            .flatMap((entry, index) => {
              return [
                "<tr>",
                "<td>" + new Date(entry.date).toLocaleString() + "</td>",
                "<td>" + entry.total_weight_mg + "</td>",
                "<td>" +
                  (entry.total_weight_mg -
                    (data[index - 1]?.total_weight_mg ?? 0)) +
                  "</td>",
                "<td>" + entry.food_height_cm + "</td>",
                "</tr>",
              ];
            })
            .join(""),
          "</tbody>",
          "</table>",
        ].join("");
        console.log(tableContent);
        tabela.innerHTML = tableContent;
      }

      function postData(host) {
        const Http = new XMLHttpRequest();
        const url = `${host}/dogfeeder`;
        Http.open("POST", url);
        Http.send(
          JSON.stringify({
            date: new Date().toISOString(),
            total_weight_mg: 1500,
            food_height_cm: 22,
          })
        );
        let executedFunction = false;
        Http.onreadystatechange = (e) => {
          if (!executedFunction && Http.responseText) {
            executedFunction = true;
            console.log(Http.responseText);
          }
        };
      }
      //   postData('http://192.168.0.14:8080');

      function getData(host) {
        const Http = new XMLHttpRequest();
        const url = `${host}/dogfeeder`;
        Http.open("GET", url);
        Http.send();
        let executedFunction = false;
        Http.onreadystatechange = (e) => {
          if (!executedFunction && Http.responseText) {
            executedFunction = true;
            data = JSON.parse(Http.responseText).map((a) => JSON.parse(a));
            console.log(data);
            renderTable(data);
          }
        };
      }
      getData("http://192.168.0.14:8080");
    </script>
  </head>
  <body>
    <header>
      <h1>Dog Feeder</h1>
    </header>
    <main>
      <div>We care about your pet when you aren't at home</div>
      <div id="tabela"></div>
    </main>
    <footer>
      Contibutors: Lucas Ennes, Rodrigo Schardong, Henrique Andrade, Matheus
      Araújo, Gabriel Camargo, Gabriel Vieira
    </footer>
  </body>
</html>
